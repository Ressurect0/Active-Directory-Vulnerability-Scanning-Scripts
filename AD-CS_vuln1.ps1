# Get the current logged-in user
$cu=(whoami | foreach {$_.split('\')[1]})

# Get all Certificate Templates
$ct = certutil -v -template |findstr /i 'TemplatePropCommonName' |ForEach-Object { $_.split(' ')[4]}

# Get all groups that the user belongs to
$groups=(Get-ADPrincipalGroupMembership -identity $cu | select name | foreach-object { $_.Name })

foreach ($i in $ct) {
    foreach ($g in $groups){
        # Check if the groups of the current user are allowed to request certificates 
        $c1e=(certutil -v -template  $i | Select-String 'allow' | select-string 'allow enroll' | select-string $g)
        $c1fc=(certutil -v -template  $i | Select-String 'allow' | select-string 'allow full control' | select-string $g)
        if ($c1e.length -gt 0 -Or $c1fc.length -gt 0)
        {
            # Check if the certificate is allowed to perform client authentication via kerberos
            $c2=(certutil -v -template $i | select-string -simplematch 'Client Authentication (1.3.6.1.5.5.7.3.2)')
            if ($c2.length -gt 0) {
                # Check if the certificate allows the user to change SAN (Subject Alternate Name)
               $c3=(certutil -v -template $i | select-string -simplematch "CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT -- 1")
                if ($c3.length -gt 0){
                echo "Vulnerable Certificate Template : $i"
                break
                }
            }
        }
    }
    
}
